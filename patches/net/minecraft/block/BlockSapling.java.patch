--- ../src-base/minecraft/net/minecraft/block/BlockSapling.java
+++ ../src-work/minecraft/net/minecraft/block/BlockSapling.java
@@ -22,6 +22,17 @@
 import net.minecraft.world.gen.feature.WorldGenTrees;
 import net.minecraft.world.gen.feature.WorldGenerator;
 
+// CraftBukkit start
+import org.bukkit.Location;
+import org.bukkit.TreeType;
+import org.bukkit.entity.Player;
+import org.bukkit.event.world.StructureGrowEvent;
+// CraftBukkit end
+// MCPC+ start
+import net.minecraft.entity.player.EntityPlayerMP;
+import net.minecraft.item.ItemDye;
+// MCPC+ end
+
 public class BlockSapling extends BlockBush implements IGrowable
 {
     public static final String[] field_149882_a = new String[] {"oak", "spruce", "birch", "jungle", "acacia", "roofed_oak"};
@@ -42,7 +53,7 @@
         {
             super.updateTick(p_149674_1_, p_149674_2_, p_149674_3_, p_149674_4_, p_149674_5_);
 
-            if (p_149674_1_.getBlockLightValue(p_149674_2_, p_149674_3_ + 1, p_149674_4_) >= 9 && p_149674_5_.nextInt(7) == 0)
+            if (p_149674_1_.getBlockLightValue(p_149674_2_, p_149674_3_ + 1, p_149674_4_) >= 9 && (p_149674_5_.nextInt(Math.max(2, (int)((p_149674_1_.growthOdds / p_149674_1_.spigotConfig.saplingModifier * 7) + 0.5F))) == 0))    // Spigot
             {
                 this.func_149879_c(p_149674_1_, p_149674_2_, p_149674_3_, p_149674_4_, p_149674_5_);
             }
@@ -75,7 +86,24 @@
     {
         if (!net.minecraftforge.event.terraingen.TerrainGen.saplingGrowTree(p_149878_1_, p_149878_5_, p_149878_2_, p_149878_3_, p_149878_4_)) return;
         int l = p_149878_1_.getBlockMetadata(p_149878_2_, p_149878_3_, p_149878_4_) & 7;
-        Object object = p_149878_5_.nextInt(10) == 0 ? new WorldGenBigTree(true) : new WorldGenTrees(true);
+        // CraftBukkit start - Records tree types
+        TreeType treeType = null;
+        // Turn ternary operator into if statement to set treeType
+        //Object object = random.nextInt(10) == 0 ? new WorldGenBigTree(true) : new WorldGenTrees(true);
+        Object object = null;
+
+        if (p_149878_5_.nextInt(10) == 0)
+        {
+            treeType = TreeType.BIG_TREE;
+            object = new WorldGenBigTree(true);
+        }
+        else
+        {
+            treeType = TreeType.TREE;
+            object = new WorldGenTrees(true);
+        }
+
+        // CraftBukkit end
         int i1 = 0;
         int j1 = 0;
         boolean flag = false;
@@ -86,6 +114,7 @@
             default:
                 break;
             case 1:
+                treeType = TreeType.REDWOOD; // CraftBukkit
                 label78:
 
                 for (i1 = 0; i1 >= -1; --i1)
@@ -110,6 +139,7 @@
 
                 break;
             case 2:
+                treeType = TreeType.BIRCH; // CraftBukkit
                 object = new WorldGenForest(true, false);
                 break;
             case 3:
@@ -121,6 +151,7 @@
                     {
                         if (this.func_149880_a(p_149878_1_, p_149878_2_ + i1, p_149878_3_, p_149878_4_ + j1, 3) && this.func_149880_a(p_149878_1_, p_149878_2_ + i1 + 1, p_149878_3_, p_149878_4_ + j1, 3) && this.func_149880_a(p_149878_1_, p_149878_2_ + i1, p_149878_3_, p_149878_4_ + j1 + 1, 3) && this.func_149880_a(p_149878_1_, p_149878_2_ + i1 + 1, p_149878_3_, p_149878_4_ + j1 + 1, 3))
                         {
+                            treeType = TreeType.JUNGLE; // CraftBukkit
                             object = new WorldGenMegaJungle(true, 10, 20, 3, 3);
                             flag = true;
                             break label93;
@@ -132,11 +163,13 @@
                 {
                     j1 = 0;
                     i1 = 0;
+                    treeType = TreeType.SMALL_JUNGLE; // CraftBukkit
                     object = new WorldGenTrees(true, 4 + p_149878_5_.nextInt(7), 3, 3, false);
                 }
 
                 break;
             case 4:
+                treeType = TreeType.ACACIA; // CraftBukkit
                 object = new WorldGenSavannaTree(true);
                 break;
             case 5:
@@ -149,6 +182,7 @@
                         if (this.func_149880_a(p_149878_1_, p_149878_2_ + i1, p_149878_3_, p_149878_4_ + j1, 5) && this.func_149880_a(p_149878_1_, p_149878_2_ + i1 + 1, p_149878_3_, p_149878_4_ + j1, 5) && this.func_149880_a(p_149878_1_, p_149878_2_ + i1, p_149878_3_, p_149878_4_ + j1 + 1, 5) && this.func_149880_a(p_149878_1_, p_149878_2_ + i1 + 1, p_149878_3_, p_149878_4_ + j1 + 1, 5))
                         {
                             object = new WorldGenCanopyTree(true);
+                            treeType = TreeType.DARK_OAK; // CraftBukkit
                             flag = true;
                             break label108;
                         }
@@ -175,8 +209,53 @@
             p_149878_1_.setBlock(p_149878_2_, p_149878_3_, p_149878_4_, block, 0, 4);
         }
 
-        if (!((WorldGenerator)object).generate(p_149878_1_, p_149878_5_, p_149878_2_ + i1, p_149878_3_, p_149878_4_ + j1))
+        // CraftBukkit start
+        // MCPC+ start - refactor for new capture logic
+        p_149878_1_.runningTreeGeneration = true;
+        p_149878_1_.captureBlockStates = true;
+        boolean grownTree = ((WorldGenerator)object).generate(p_149878_1_, p_149878_5_, p_149878_2_ + i1, p_149878_3_, p_149878_4_ + j1);
+        p_149878_1_.captureBlockStates = false;
+        p_149878_1_.runningTreeGeneration = false;
+
+        if (grownTree)
         {
+            // MCPC+ start - get player
+            EntityPlayerMP entityplayer = (EntityPlayerMP)ItemStack.currentPlayer;
+            Player player = entityplayer != null ? entityplayer.getBukkitEntity() : null;
+            ItemStack itemstack = null;
+            boolean bonemeal = false;
+            if (entityplayer != null && entityplayer.getCurrentEquippedItem() != null)
+            {
+                bonemeal = (entityplayer.getCurrentEquippedItem().getItem() instanceof ItemDye && entityplayer.getCurrentEquippedItem().getItemDamage() == 15);
+                itemstack = entityplayer.getCurrentEquippedItem();
+            }
+            // MCPC+ end
+            Location location = new Location(p_149878_1_.getWorld(), p_149878_2_, p_149878_3_, p_149878_4_);
+            StructureGrowEvent event = new StructureGrowEvent(location, treeType, bonemeal, player, p_149878_1_.capturedBlockStates);
+            org.bukkit.Bukkit.getPluginManager().callEvent(event);
+
+            if (event.isCancelled())
+            {
+                grownTree = false;
+            }
+            else
+            {
+                for (org.bukkit.block.BlockState state : event.getBlocks())
+                {
+                    state.update(true);
+                }
+
+                if (event.isFromBonemeal() && itemstack != null)
+                {
+                    --itemstack.stackSize;
+                }
+            }
+        }
+
+        // No need to generate the tree again.
+        if (!grownTree)
+        {
+            // CraftBukkit end
             if (flag)
             {
                 p_149878_1_.setBlock(p_149878_2_ + i1, p_149878_3_, p_149878_4_ + j1, this, l, 4);
