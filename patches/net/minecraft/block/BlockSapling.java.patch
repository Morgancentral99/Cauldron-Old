--- ../src-base/minecraft/net/minecraft/block/BlockSapling.java
+++ ../src-work/minecraft/net/minecraft/block/BlockSapling.java
@@ -22,6 +22,15 @@
 import net.minecraft.world.gen.feature.WorldGenTrees;
 import net.minecraft.world.gen.feature.WorldGenerator;
 
+// CraftBukkit start
+import org.bukkit.Location;
+import org.bukkit.TreeType;
+import org.bukkit.craftbukkit.CraftBlockChangeDelegate;
+import org.bukkit.craftbukkit.util.StructureGrowDelegate;
+import org.bukkit.entity.Player;
+import org.bukkit.event.world.StructureGrowEvent;
+// CraftBukkit end
+
 public class BlockSapling extends BlockBush implements IGrowable
 {
     public static final String[] field_149882_a = new String[] {"oak", "spruce", "birch", "jungle", "acacia", "roofed_oak"};
@@ -41,9 +50,9 @@
         {
             super.func_149674_a(p_149674_1_, p_149674_2_, p_149674_3_, p_149674_4_, p_149674_5_);
 
-            if (p_149674_1_.getBlockLightValue(p_149674_2_, p_149674_3_ + 1, p_149674_4_) >= 9 && p_149674_5_.nextInt(7) == 0)
+            if (p_149674_1_.getBlockLightValue(p_149674_2_, p_149674_3_ + 1, p_149674_4_) >= 9 && (p_149674_5_.nextInt(Math.max(2, (int)((p_149674_1_.growthOdds / p_149674_1_.spigotConfig.saplingModifier * 7) + 0.5F))) == 0))    // Spigot
             {
-                this.func_149879_c(p_149674_1_, p_149674_2_, p_149674_3_, p_149674_4_, p_149674_5_);
+                this.grow(p_149674_1_, p_149674_2_, p_149674_3_, p_149674_4_, p_149674_5_, false, null, null); // CraftBukkit - added bonemeal, player and itemstack
             }
         }
     }
@@ -69,6 +78,7 @@
         }
     }
 
+    // MCPC+ start - vanilla compatibility
     public void func_149878_d(World p_149878_1_, int p_149878_2_, int p_149878_3_, int p_149878_4_, Random p_149878_5_)
     {
         if (!net.minecraftforge.event.terraingen.TerrainGen.saplingGrowTree(p_149878_1_, p_149878_5_, p_149878_2_, p_149878_3_, p_149878_4_)) return;
@@ -188,7 +198,200 @@
             }
         }
     }
+    // MCPC+ end
 
+    // CraftBukkit - added bonemeal, player and itemstack
+    public void grow(World world, int i, int j, int k, Random random, boolean bonemeal, Player player, ItemStack itemstack)
+    {
+        int l = world.getBlockMetadata(i, j, k);
+
+        if ((l & 8) == 0)
+        {
+            world.setBlockMetadataWithNotify(i, j, k, l | 8, 4);
+        }
+        else
+        {
+            this.CB_grow(world, i, j, k, random, bonemeal, player, itemstack); // CraftBukkit
+        }
+    }
+
+    // CraftBukkit - Added bonemeal, player and itemstack
+    public void CB_grow(World world, int i, int j, int k, Random random, boolean bonemeal, Player player, ItemStack itemstack)
+    {
+        int l = world.getBlockMetadata(i, j, k) & 7;
+        // CraftBukkit start - Records tree generation and calls StructureGrowEvent
+        StructureGrowDelegate delegate = new StructureGrowDelegate(world);
+        TreeType treeType = null;
+        boolean grownTree = false;
+        // Turn ternary operator into if statement to set treeType
+        //Object object = random.nextInt(10) == 0 ? new WorldGenBigTree(true) : new WorldGenTrees(true);
+        TreeGenerator object; // Changed to TreeGenerator
+
+        if (random.nextInt(10) == 0)
+        {
+            treeType = TreeType.BIG_TREE;
+            object = new WorldGenBigTree(true);
+        }
+        else
+        {
+            treeType = TreeType.TREE;
+            object = new WorldGenTrees(true);
+        }
+
+        // CraftBukkit end
+        int i1 = 0;
+        int j1 = 0;
+        boolean flag = false;
+
+        switch (l)
+        {
+            case 0:
+            default:
+                break;
+            case 1:
+                treeType = TreeType.REDWOOD; // CraftBukkit
+                label78:
+
+                for (i1 = 0; i1 >= -1; --i1)
+                {
+                    for (j1 = 0; j1 >= -1; --j1)
+                    {
+                        if (this.func_149880_a(world, i + i1, j, k + j1, 1) && this.func_149880_a(world, i + i1 + 1, j, k + j1, 1) && this.func_149880_a(world, i + i1, j, k + j1 + 1, 1) && this.func_149880_a(world, i + i1 + 1, j, k + j1 + 1, 1))
+                        {
+                            object = new WorldGenMegaPineTree(false, random.nextBoolean());
+                            flag = true;
+                            break label78;
+                        }
+                    }
+                }
+
+                if (!flag)
+                {
+                    j1 = 0;
+                    i1 = 0;
+                    object = new WorldGenTaiga2(true);
+                }
+
+                break;
+            case 2:
+                treeType = TreeType.BIRCH; // CraftBukkit
+                object = new WorldGenForest(true, false);
+                break;
+            case 3:
+                label93:
+                for (i1 = 0; i1 >= -1; --i1)
+                {
+                    for (j1 = 0; j1 >= -1; --j1)
+                    {
+                        if (this.func_149880_a(world, i + i1, j, k + j1, 3) && this.func_149880_a(world, i + i1 + 1, j, k + j1, 3) && this.func_149880_a(world, i + i1, j, k + j1 + 1, 3) && this.func_149880_a(world, i + i1 + 1, j, k + j1 + 1, 3))
+                        {
+                            treeType = TreeType.JUNGLE; // CraftBukkit
+                            object = new WorldGenMegaJungle(true, 10, 20, 3, 3);
+                            flag = true;
+                            break label93;
+                        }
+                    }
+                }
+
+                if (!flag)
+                {
+                    j1 = 0;
+                    i1 = 0;
+                    treeType = TreeType.SMALL_JUNGLE; // CraftBukkit
+                    object = new WorldGenTrees(true, 4 + random.nextInt(7), 3, 3, false);
+                }
+
+                break;
+            case 4:
+                treeType = TreeType.ACACIA; // CraftBukkit
+                object = new WorldGenSavannaTree(true);
+                break;
+            case 5:
+                label108:
+                for (i1 = 0; i1 >= -1; --i1)
+                {
+                    for (j1 = 0; j1 >= -1; --j1)
+                    {
+                        if (this.func_149880_a(world, i + i1, j, k + j1, 5) && this.func_149880_a(world, i + i1 + 1, j, k + j1, 5) && this.func_149880_a(world, i + i1, j, k + j1 + 1, 5) && this.func_149880_a(world, i + i1 + 1, j, k + j1 + 1, 5))
+                        {
+                            object = new WorldGenCanopyTree(true);
+                            treeType = TreeType.DARK_OAK; // CraftBukkit
+                            flag = true;
+                            break label108;
+                        }
+                    }
+                }
+
+                if (!flag)
+                {
+                    return;
+                }
+        }
+
+        Block block = Blocks.air;
+
+        if (flag)
+        {
+            world.func_147465_d(i + i1, j, k + j1, block, 0, 4);
+            world.func_147465_d(i + i1 + 1, j, k + j1, block, 0, 4);
+            world.func_147465_d(i + i1, j, k + j1 + 1, block, 0, 4);
+            world.func_147465_d(i + i1 + 1, j, k + j1 + 1, block, 0, 4);
+        }
+        else
+        {
+            world.func_147465_d(i, j, k, block, 0, 4);
+        }
+
+        // CraftBukkit start
+        grownTree = object.generate(new CraftBlockChangeDelegate(delegate), random, i + i1, j, k + j1);
+
+        if (grownTree)
+        {
+            Location location = new Location(world.getWorld(), i, j, k);
+            StructureGrowEvent event = new StructureGrowEvent(location, treeType, bonemeal, player, delegate.getBlocks());
+            org.bukkit.Bukkit.getPluginManager().callEvent(event);
+
+            if (event.isCancelled())
+            {
+                grownTree = false;
+            }
+            else
+            {
+                for (org.bukkit.block.BlockState state : event.getBlocks())
+                {
+                    state.update(true);
+                }
+
+                if (event.isFromBonemeal() && itemstack != null)
+                {
+                    --itemstack.stackSize;
+                }
+            }
+        }
+        else if (bonemeal && itemstack != null)
+        {
+            // We always consume bonemeal when trying to grow
+            --itemstack.stackSize;
+        }
+
+        // No need to generate the tree again.
+        if (!grownTree)
+        {
+            // CraftBukkit end
+            if (flag)
+            {
+                world.func_147465_d(i + i1, j, k + j1, this, l, 4);
+                world.func_147465_d(i + i1 + 1, j, k + j1, this, l, 4);
+                world.func_147465_d(i + i1, j, k + j1 + 1, this, l, 4);
+                world.func_147465_d(i + i1 + 1, j, k + j1 + 1, this, l, 4);
+            }
+            else
+            {
+                world.func_147465_d(i, j, k, this, l, 4);
+            }
+        }
+    }
+
     public boolean func_149880_a(World p_149880_1_, int p_149880_2_, int p_149880_3_, int p_149880_4_, int p_149880_5_)
     {
         return p_149880_1_.func_147439_a(p_149880_2_, p_149880_3_, p_149880_4_) == this && (p_149880_1_.getBlockMetadata(p_149880_2_, p_149880_3_, p_149880_4_) & 7) == p_149880_5_;
@@ -231,6 +434,15 @@
 
     public void func_149853_b(World p_149853_1_, Random p_149853_2_, int p_149853_3_, int p_149853_4_, int p_149853_5_)
     {
-        this.func_149879_c(p_149853_1_, p_149853_3_, p_149853_4_, p_149853_5_, p_149853_2_);
+        this.grow(p_149853_1_, p_149853_3_, p_149853_4_, p_149853_5_, p_149853_2_, false, null, null); // CraftBukkit - added bonemeal, player and itemstack
     }
+
+    // CraftBukkit start
+    public interface TreeGenerator
+    {
+        public boolean generate(World world, Random random, int i, int j, int k);
+
+        public boolean generate(org.bukkit.craftbukkit.CraftBlockChangeDelegate world, Random random, int i, int j, int k);
+    }
+    // CraftBukkit end
 }
